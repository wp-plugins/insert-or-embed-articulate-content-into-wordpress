<?phpfunction printInsertForm(){$dirs = getDirs();if (count($dirs)>0){echo '<script src='.getPluginUrl()."/jquery.js></script>";?><script src="<?php echo getPluginUrl()."jquery.form.js";?>" ></script><script>jQuery(document).ready(function() {             jQuery('.insert').click(function(){			var dir = jQuery(this).attr('class').split(/\s+/);			dir1 = dir[1];			var index = dir[2];			dir = "<?php echo getUploadsUrl(); ?>"+dir1+"/"+index;			var win = window.dialogArguments || opener || parent || top; 			win.send_to_editor("[iframe_loader width='100%' height='600' frameborder='0' src='"+dir+"']");			});					jQuery('.del').click(function(){			if (confirm("Are you sure?"))			{			var dir = jQuery(this).attr('class').split(/\s+/);			dir = (dir[1]);						jQuery.post("admin-ajax.php",{dir : dir,action:'del_dir'},function(data){			location.reload();						});			}			});				});</script><title>Media Library</title><?phpecho "<table class='widefat'>";foreach ($dirs as $i=>$dir):extract($dir);$dir1 = str_replace("_"," " ,$dir);if ($i % 2 == 0)echo "<tr class='iedit'><td>$dir1</td><td><input type='submit' value='Delete' class='del $dir'  /></td><td><input type='submit' class='insert $dir $file'  value='Insert'/></td></tr>";elseecho "<tr class='alternate iedit'><td>$dir1</td><td><input type='submit' class='del $dir' value='Delete'/></td><td><input type='submit' class='insert $dir $file'  value='Insert'/></td></tr>";endforeach;echo "</table>";}elseecho "no directories available";}function getUploadsPath(){$dir = wp_upload_dir();return ($dir['basedir'] . "/articulate_uploads/");}function getUploadsUrl(){$dir = wp_upload_dir();return $dir['baseurl'] . "/articulate_uploads/";}function getPluginUrl(){return WP_PLUGIN_URL."/insert-or-embed-articulate-content-into-wordpress/";}function getDirs(){$myDirectory = opendir(getUploadsPath());$dirArray = array();$i=0;// get each entrywhile($entryName = readdir($myDirectory)) {	if ($entryName != "." && $entryName !=".." && is_dir(getUploadsPath().$entryName)):	$dirArray[$i]['dir'] = $entryName;	$dirArray[$i]['file'] = getFile(getUploadsPath().$entryName);	$i++;	endif;}// close directoryclosedir($myDirectory);return $dirArray;}function getFile($dir){$myDirectory = opendir($dir);$fileArray = array();// get each entrywhile($entryName = readdir($myDirectory)) {	if ($entryName != "." && $entryName !="..")	{	$f = getUploadsPath().$entryName;	$ext = pathinfo ($f,PATHINFO_EXTENSION);	if ($ext == "html"):	closedir($myDirectory);	return $entryName;	endif;	}}return false;}function print_upload(){wp_enqueue_script("jquery");?><script src="<?php echo getPluginUrl()."jquery.form.js";?>" ></script><script>jQuery(document).ready(function() { 			jQuery("#media_loading").hide();			            jQuery('#myForm1').ajaxForm(			{			success : function(data) { 				data = eval('(' + data + ')');              if (data[0] == "uploaded")			  {				dir = data[1];				var win = window.dialogArguments || opener || parent || top; 				win.send_to_editor("[iframe_loader width='100%' height='600' frameborder='0' src='"+dir+"']");				jQuery("#media_loading").hide();			  }else{			  jQuery("#media_loading").hide();			  alert(data);			  }			              },			beforeSubmit: function()			{			jQuery("#media_loading").show();			}						});  });</script><form enctype="multipart/form-data" id="myForm1" action="admin-ajax.php" method="POST"><input type="hidden" name="action" value="quiz_upload" /><input type="hidden" name="MAX_FILE_SIZE" value="1000000000" />Choose a file to upload: <input name="uploadedfile" type="file" /><br /><input type="submit" value="Upload File" /></form><p><i>Please choose a .zip file that you published with the Articulate software</i></p><img id="media_loading" style='display:none;' src= "<?php echo getPluginUrl() . "loading.gif" ;?>" /><p><b>Need help?  See the screencast below:</b></p><iframe src="http://www.screenr.com/embed/zSSs" width="600" height="366" frameborder="0"></iframe><p/><?php}function wp_ajax_del_dir(){$dir = getUploadsPath().$_POST['dir'];rrmdir($dir);die();}function wp_ajax_quiz_upload(){ $arr = array();$file = $_FILES['uploadedfile']['tmp_name'];$dir = explode(".",$_FILES['uploadedfile']['name']);$dir[0] = str_replace(" ","_",$dir[0]);$target = getUploadsPath().$dir[0];$index = count($dir) -1;if (!isset($dir[$index]) || $dir[$index] != "zip")$arr[0] = "the file must be zip archive";else{while(file_exists($target)){$r = rand(1,10);$target .= $r;$dir[0] .= $r;}if (!empty($file))$arr = extractZip($file,$target,$dir[0]);else$arr[0] ="file is too big";}echo json_encode($arr);die();}function extractZip($fileName,$target,$dir){		 $arr = array(); $zip = new ZipArchive;     $res = $zip->open($fileName);     if ($res === TRUE) {         $zip->extractTo($target);         $zip->close();		 $file = getFile($target);		 $arr[0] = 'uploaded'; 		 $arr[1] = getUploadsUrl().$dir."/".$file;               } else {		$arr[0] ="file upload failed";           }	 return  $arr;}function rrmdir($dir) {   if (is_dir($dir)) {     $objects = scandir($dir);     foreach ($objects as $object) {       if ($object != "." && $object != "..") {         if (filetype($dir."/".$object) == "dir") rrmdir($dir."/".$object); else unlink($dir."/".$object);       }     }     reset($objects);     rmdir($dir);   } } ?>